name: Delete All Workflow Runs

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE ALL" to confirm deletion of all workflow runs'
        required: true
        default: ''

jobs:
  delete-all:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE ALL'
    permissions:
      actions: write
      contents: read
    
    steps:
      - name: Confirm deletion
        run: |
          echo "‚ö†Ô∏è WARNING: This will delete ALL workflow runs!"
          echo "Confirmation received: ${{ github.event.inputs.confirm }}"
      
      - name: Delete all workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            console.log(`Fetching all workflows for ${owner}/${repo}...`);
            
            // Get all workflows
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo,
            });
            
            console.log(`Found ${workflows.data.total_count} workflows`);
            
            // For each workflow, delete all runs
            for (const workflow of workflows.data.workflows) {
              console.log(`\nProcessing workflow: ${workflow.name} (ID: ${workflow.id})`);
              
              let page = 1;
              let hasMore = true;
              let totalDeleted = 0;
              
              while (hasMore) {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: workflow.id,
                  per_page: 100,
                  page: page,
                });
                
                if (runs.data.workflow_runs.length === 0) {
                  hasMore = false;
                  break;
                }
                
                console.log(`  Page ${page}: Found ${runs.data.workflow_runs.length} runs`);
                
                for (const run of runs.data.workflow_runs) {
                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner,
                      repo,
                      run_id: run.id,
                    });
                    totalDeleted++;
                    
                    if (totalDeleted % 10 === 0) {
                      console.log(`  Deleted ${totalDeleted} runs...`);
                    }
                  } catch (error) {
                    console.log(`  Failed to delete run ${run.id}: ${error.message}`);
                  }
                }
                
                page++;
              }
              
              console.log(`  ‚úÖ Deleted ${totalDeleted} runs for workflow: ${workflow.name}`);
            }
            
            console.log('\nüéâ All workflow runs have been deleted!');
      
      - name: Deletion cancelled
        if: github.event.inputs.confirm != 'DELETE ALL'
        run: |
          echo "‚ùå Deletion cancelled. You must type 'DELETE ALL' to confirm."
          exit 1
